
server {
    listen 80;
    server_name myagi.com.au www.myagi.com.au;
    rewrite ^(.*)$ https://myagi.com$request_uri permanent;
}

server {
    listen 80;

    # Enable gzip
    gzip on;
  	gzip_disable "msie6";
  	gzip_vary on;
  	gzip_proxied any;
  	gzip_comp_level 6;
  	gzip_buffers 16 8k;
  	gzip_http_version 1.1;
  	gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    server_name {% for domain in domains %}{{ domain }} {% endfor %}{{ access_domain }};
    root /home/myagi/nginx/;
    access_log /var/log/nginx/myagi.access.log;
    error_log /var/log/nginx/myagi.error.log error;

    if ($http_x_forwarded_proto != "https") {
        rewrite ^(.*)$ https://$host$request_uri permanent;
    }

    # encourage HTTPS
    add_header Strict-Transport-Security max-age=31536000;

    error_page 503 @maintenance;
    location @maintenance {
        if ($host != "{{ access_domain }}") {
            rewrite ^(.*)$ /maintenance.html break;
        }
    }

    error_page 404 /404.html;

    location /static {
        expires max;
        add_header Cache-Control "public";
        add_header Access-Control-Allow-Origin *;
        alias /home/myagi/static;
    }

    location /css {
        expires max;
        add_header Cache-Control "public";
        add_header Access-Control-Allow-Origin *;
        alias /home/myagi/static/css;
    }

    location /js {
        expires max;
        add_header Cache-Control "public";
        add_header Access-Control-Allow-Origin *;
        alias /home/myagi/static/js;
    }

    location /img {
        expires max;
        add_header Cache-Control "public";
        add_header Access-Control-Allow-Origin *;
        alias /home/myagi/static/img;
    }

    location /new_public {
        # New public site built using Hugo
        alias /home/myagi/src/public-site/public;
    }

    location /de {
        # German version of public site. Have hardcoded this
        # until we have deployed the public site on the root URL
        # (i.e. without the /new_public path).
        alias /home/myagi/src/public-site/public/de;
    }

    location @web_workers {
        proxy_set_header Host $http_host;
        # Set timeout to 5 minutes
        proxy_read_timeout 300;
        # myagi_web_workers upstream is defined in the default config file,
        # because it is used there to expose the healthcheck endpoint
        proxy_pass http://myagi_web_workers;
    }

    location / {
        client_max_body_size 15m;
        # standard maintenance page test
        if (-f $document_root/maintenance.html) {
            return 503;
        }
        try_files $uri @web_workers;
    }
}
