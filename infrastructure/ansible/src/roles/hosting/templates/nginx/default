# It expects to be placed behind a load balancer
# which terminates SSL and sets the X-Forwarded-Proto header.

upstream myagi_web_workers {
    server unix:/tmp/myagi_web_workers.sock fail_timeout=0;
}

server {
    listen 80 default_server; # IPv4
    ## Socket options can only be specified once, hence the different
    ## address for the 'default' server.
    listen [::]:80 default_server ipv6only=on; # IPv6

    # Only required so that the healthcheck endpoint can be exposed
    location @web_workers {
        # Set header to localhost so that ALLOWED_HOSTS setting does not
        # block the request
        proxy_set_header Host localhost;
        # Set timeout to 5 minutes
        proxy_read_timeout 300;
        # myagi_web_workers upstream is defined in the default config file,
        # because it is used there to expose the healthcheck endpoint
        proxy_pass http://myagi_web_workers;
    }

    # Only expose the upstream healthcheck endpoint
    # when accessed without a server name
    location /healthcheck {
        try_files $uri @web_workers;
    }

    location / {
        # 444 No Response (Nginx)
        #  Used in Nginx logs to indicate that the server has returned no
        #  information to the client and closed the connection (useful as a
        #  deterrent for malware).
        return 444;
    }
}
